<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Recursive operators and functions - Apalache Documentation</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Overview</a></li><li class="chapter-item expanded affix "><li class="part-title">Tutorials</li><li class="chapter-item expanded "><a href="../../tutorials/index.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../tutorials/entry-tutorial.html"><strong aria-hidden="true">2.</strong> Entry-level Model Checker Tutorial</a></li><li class="chapter-item expanded "><a href="../../tutorials/snowcat-tutorial.html"><strong aria-hidden="true">3.</strong> Type Checker Tutorial</a></li><li class="chapter-item expanded "><a href="../../tutorials/pluscal-tutorial.html"><strong aria-hidden="true">4.</strong> Checking Pluscal specifications</a></li><li class="chapter-item expanded "><a href="../../tutorials/trail-tips.html"><strong aria-hidden="true">5.</strong> Apalache trail tips: how to check your specs faster</a></li><li class="chapter-item expanded "><a href="../../tutorials/symbmc.html"><strong aria-hidden="true">6.</strong> Symbolic Model Checking</a></li><li class="chapter-item expanded affix "><li class="part-title">Apalache User Manual</li><li class="chapter-item expanded "><a href="../../apalache/index.html"><strong aria-hidden="true">7.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../../apalache/getting-started.html"><strong aria-hidden="true">8.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../apalache/apalache-or-tlc.html"><strong aria-hidden="true">8.1.</strong> Shall I use Apalache or TLC?</a></li><li class="chapter-item expanded "><a href="../../apalache/system-reqs.html"><strong aria-hidden="true">8.2.</strong> System Requirements</a></li><li class="chapter-item expanded "><a href="../../apalache/installation/index.html"><strong aria-hidden="true">8.3.</strong> Installation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../apalache/installation/jvm.html"><strong aria-hidden="true">8.3.1.</strong> Prebuilt Packages</a></li><li class="chapter-item expanded "><a href="../../apalache/installation/docker.html"><strong aria-hidden="true">8.3.2.</strong> Docker</a></li><li class="chapter-item expanded "><a href="../../apalache/installation/source.html"><strong aria-hidden="true">8.3.3.</strong> Source</a></li></ol></li><li class="chapter-item expanded "><a href="../../apalache/running.html"><strong aria-hidden="true">8.4.</strong> Running the Tool</a></li><li class="chapter-item expanded "><a href="../../apalache/example.html"><strong aria-hidden="true">8.5.</strong> An Example TLA+ Specification</a></li><li class="chapter-item expanded "><a href="../../apalache/parameters.html"><strong aria-hidden="true">8.6.</strong> Specification Parameters</a></li><li class="chapter-item expanded "><a href="../../apalache/principles/index.html"><strong aria-hidden="true">8.7.</strong> Symbolic Model Checking with Apalache</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../apalache/principles/assignments.html"><strong aria-hidden="true">8.7.1.</strong> Assignments and symbolic transitions</a></li><li class="chapter-item expanded "><a href="../../apalache/principles/folds.html"><strong aria-hidden="true">8.7.2.</strong> Folding sets and sequences</a></li><li class="chapter-item expanded "><a href="../../apalache/principles/invariants.html"><strong aria-hidden="true">8.7.3.</strong> Invariants: State, Action, Trace</a></li><li class="chapter-item expanded "><a href="../../apalache/principles/enumeration.html"><strong aria-hidden="true">8.7.4.</strong> Enumeration of counterexamples</a></li><li class="chapter-item expanded "><a href="../../apalache/principles/apalache-mod.html"><strong aria-hidden="true">8.7.5.</strong> The Apalache Module</a></li><li class="chapter-item expanded "><a href="../../apalache/principles/recursive.html" class="active"><strong aria-hidden="true">8.7.6.</strong> Recursive operators and functions</a></li><li class="chapter-item expanded "><a href="../../apalache/principles/naturals.html"><strong aria-hidden="true">8.7.7.</strong> Naturals</a></li></ol></li><li class="chapter-item expanded "><a href="../../apalache/config.html"><strong aria-hidden="true">8.8.</strong> Apalache global configuration file</a></li><li class="chapter-item expanded "><a href="../../apalache/statistics.html"><strong aria-hidden="true">8.9.</strong> TLA+ Execution Statistics</a></li><li class="chapter-item expanded "><a href="../../apalache/profiling.html"><strong aria-hidden="true">8.10.</strong> Profiling Your Specification</a></li><li class="chapter-item expanded "><a href="../../apalache/theory.html"><strong aria-hidden="true">8.11.</strong> Five minutes of theory</a></li></ol></li><li class="chapter-item expanded "><a href="../../apalache/tlc-config.html"><strong aria-hidden="true">9.</strong> TLC Configuration Files</a></li><li class="chapter-item expanded "><a href="../../apalache/typechecker-snowcat.html"><strong aria-hidden="true">10.</strong> The Snowcat Type Checker</a></li><li class="chapter-item expanded "><a href="../../apalache/features.html"><strong aria-hidden="true">11.</strong> Supported Features</a></li><li class="chapter-item expanded "><a href="../../apalache/known-issues.html"><strong aria-hidden="true">12.</strong> Known Issues</a></li><li class="chapter-item expanded "><a href="../../apalache/antipatterns.html"><strong aria-hidden="true">13.</strong> Antipatterns</a></li><li class="chapter-item expanded "><a href="../../apalache/preprocessing.html"><strong aria-hidden="true">14.</strong> TLA+ Preprocessing</a></li><li class="chapter-item expanded "><a href="../../apalache/tuning.html"><strong aria-hidden="true">15.</strong> Fine Tuning</a></li><li class="chapter-item expanded "><a href="../../apalache/assignments-in-depth.html"><strong aria-hidden="true">16.</strong> Assignments and Symbolic Transitions in Depth</a></li><li class="chapter-item expanded "><a href="../../apalache/kera.html"><strong aria-hidden="true">17.</strong> KerA: kernel logic of actions</a></li><li class="chapter-item expanded affix "><li class="part-title">HOWTOs</li><li class="chapter-item expanded "><a href="../../HOWTOs/index.html"><strong aria-hidden="true">18.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../HOWTOs/howto-write-type-annotations.html"><strong aria-hidden="true">19.</strong> How to write type annotations</a></li><li class="chapter-item expanded "><a href="../../HOWTOs/uninterpretedTypes.html"><strong aria-hidden="true">20.</strong> How to use uninterpreted types</a></li><li class="chapter-item expanded affix "><li class="part-title">TLA+ Language Manual for Engineers</li><li class="chapter-item expanded "><a href="../../lang/index.html"><strong aria-hidden="true">21.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../../lang/standard-operators.html"><strong aria-hidden="true">22.</strong> The standard operators of TLA+</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../lang/booleans.html"><strong aria-hidden="true">22.1.</strong> Booleans</a></li><li class="chapter-item expanded "><a href="../../lang/control-and-nondeterminism.html"><strong aria-hidden="true">22.2.</strong> Control And Nondeterminism</a></li><li class="chapter-item expanded "><a href="../../lang/conditionals.html"><strong aria-hidden="true">22.3.</strong> Conditionals</a></li><li class="chapter-item expanded "><a href="../../lang/integers.html"><strong aria-hidden="true">22.4.</strong> Integers</a></li><li class="chapter-item expanded "><a href="../../lang/sets.html"><strong aria-hidden="true">22.5.</strong> Sets</a></li><li class="chapter-item expanded "><a href="../../lang/logic.html"><strong aria-hidden="true">22.6.</strong> Logic</a></li><li class="chapter-item expanded "><a href="../../lang/functions.html"><strong aria-hidden="true">22.7.</strong> Functions</a></li><li class="chapter-item expanded "><a href="../../lang/records.html"><strong aria-hidden="true">22.8.</strong> Records</a></li><li class="chapter-item expanded "><a href="../../lang/tuples.html"><strong aria-hidden="true">22.9.</strong> Tuples</a></li><li class="chapter-item expanded "><a href="../../lang/sequences.html"><strong aria-hidden="true">22.10.</strong> Sequences</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">22.11.</strong> Bags</div></li></ol></li><li class="chapter-item expanded "><a href="../../lang/user-operators.html"><strong aria-hidden="true">23.</strong> User-defined operators</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../lang/user/top-level-operators.html"><strong aria-hidden="true">23.1.</strong> Top-level operator definitions</a></li><li class="chapter-item expanded "><a href="../../lang/user/let-in.html"><strong aria-hidden="true">23.2.</strong> LET-IN definitions</a></li><li class="chapter-item expanded "><a href="../../lang/user/higher-order-operators.html"><strong aria-hidden="true">23.3.</strong> Higher-order operators definitions</a></li><li class="chapter-item expanded "><a href="../../lang/user/lambdas.html"><strong aria-hidden="true">23.4.</strong> Anonymous operator definitions</a></li><li class="chapter-item expanded "><a href="../../lang/user/recursive-operators.html"><strong aria-hidden="true">23.5.</strong> Recursive operator definitions</a></li><li class="chapter-item expanded "><a href="../../lang/user/local-operators.html"><strong aria-hidden="true">23.6.</strong> Local operator definitions</a></li><li class="chapter-item expanded "><a href="../../lang/user/recursive-functions.html"><strong aria-hidden="true">23.7.</strong> Recursive functions</a></li></ol></li><li class="chapter-item expanded "><a href="../../lang/apalache-operators.html"><strong aria-hidden="true">24.</strong> Apalache operators</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">25.</strong> Modules, Extends, and Instances</div></li><li class="chapter-item expanded affix "><li class="part-title">Idiomatic TLA+</li><li class="chapter-item expanded "><a href="../../idiomatic/index.html"><strong aria-hidden="true">26.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../../idiomatic/000keep-minimum-state-variables.html"><strong aria-hidden="true">27.</strong> Keep state variables to the minimum</a></li><li class="chapter-item expanded "><a href="../../idiomatic/001assignments.html"><strong aria-hidden="true">28.</strong> Update state variables with assignments</a></li><li class="chapter-item expanded "><a href="../../idiomatic/002primes.html"><strong aria-hidden="true">29.</strong> Apply primes only to state variables</a></li><li class="chapter-item expanded "><a href="../../idiomatic/007if-then-else.html"><strong aria-hidden="true">30.</strong> Use Boolean operators in actions, not IF-THEN-ELSE</a></li><li class="chapter-item expanded "><a href="../../idiomatic/003record-sets.html"><strong aria-hidden="true">31.</strong> Avoid sets of mixed records</a></li><li class="chapter-item expanded affix "><li class="part-title">Design Documents</li><li class="chapter-item expanded "><a href="../../adr/002adr-types.html"><strong aria-hidden="true">32.</strong> ADR-002: types and type annotations</a></li><li class="chapter-item expanded "><a href="../../adr/003adr-trex.html"><strong aria-hidden="true">33.</strong> ADR-003: transition executor (TRex)</a></li><li class="chapter-item expanded "><a href="../../adr/004adr-annotations.html"><strong aria-hidden="true">34.</strong> ADR-004: code annotations</a></li><li class="chapter-item expanded "><a href="../../adr/005adr-json.html"><strong aria-hidden="true">35.</strong> ADR-005: JSON Serialization Format</a></li><li class="chapter-item expanded "><a href="../../adr/006rfc-unit-testing.html"><strong aria-hidden="true">36.</strong> RFC-006: unit tests and property-based tests</a></li><li class="chapter-item expanded "><a href="../../adr/007adr-restructuring.html"><strong aria-hidden="true">37.</strong> ADR-007: restructuring</a></li><li class="chapter-item expanded "><a href="../../adr/008adr-exceptions.html"><strong aria-hidden="true">38.</strong> ADR-008: exceptions</a></li><li class="chapter-item expanded "><a href="../../adr/009adr-outputs.html"><strong aria-hidden="true">39.</strong> ADR-009: outputs</a></li><li class="chapter-item expanded "><a href="../../adr/011adr-smt-arrays.html"><strong aria-hidden="true">40.</strong> ADR-011: alternative SMT encoding using arrays</a></li><li class="chapter-item expanded "><a href="../../adr/015adr-trace.html"><strong aria-hidden="true">41.</strong> ADR-015: ITF: informal trace format</a></li><li class="chapter-item expanded "><a href="../../adr/016adr-retla.html"><strong aria-hidden="true">42.</strong> ADR-016: ReTLA: Relational TLA</a></li><li class="chapter-item expanded "><a href="../../adr/017pdr-temporal.html"><strong aria-hidden="true">43.</strong> PDR-017: Checking temporal properties</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Apalache Documentation</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/informalsystems/apalache" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><a name="recursion"></a></p>
<h2><a class="header" href="#recursive-operators-and-functions" id="recursive-operators-and-functions">Recursive operators and functions</a></h2>
<p><strong>We are going to remove support for recursive operators and functions soon.
See <a href="./folds.html">Folding sets and sequences</a>.</strong></p>
<p><strong>WARNING:</strong> In our experience, it is hard to check recursive operators and
functions in Apalache:</p>
<ul>
<li>Recursive operators need additional annotations.</li>
<li>Resursive operators and functions usually apply <code>CHOOSE</code>, which
is hard to implement faithfully without blowing up the SMT encoding.</li>
</ul>
<p>Hence, we recommend using the operators <code>FoldSet</code> and <code>FoldSeq</code>:</p>
<pre><code class="language-tla">(**
 * As TLA+ is untyped, one can use function- and sequence-specific operators
 * interchangeably. However, to maintain correctness w.r.t. our type-system,
 * an explicit cast is needed when using functions as sequences.
 * FunAsSeq reinterprets a function over integers as a sequence.
 *
 * The parameters have the following meaning:
 *
 *  - fn is the function from 1..len that should be interpreted as a sequence.
 *  - len is the length of the sequence, len = Cardinality(DOMAIN fn),
 *    len may be a variable, a computable expression, etc.
 *  - capacity is a static upper bound on the length, that is, len &lt;= capacity.
 *
 * @type: ((Int -&gt; a), Int, Int) =&gt; Seq(a);
 *)
FunAsSeq(fn, len, capacity) ==
    LET __FunAsSeq_elem_ctor(i) == fn[i] IN
    SubSeq(MkSeq(capacity, __FunAsSeq_elem_ctor), 1, len)

(**
 * Annotating an expression \E x \in S: P as Skolemizable. That is, it can
 * be replaced with an expression c \in S /\ P(c) for a fresh constant c.
</code></pre>
<p>These operators are treated by Apalache in a more efficient manner than
recursive operators. They are always terminating and thus do not require an
annotation that specifies an upper bound on the number of operator iterations.
We are preparing a tutorial on this topic.</p>
<p><strong>See <a href="./folds.html">Folding sets and sequences</a>.</strong></p>
<p><a name="rec-op"></a></p>
<h3><a class="header" href="#recursive-operators" id="recursive-operators">Recursive operators</a></h3>
<p>In the preprocessing phase, Apalache replaces every application of a user
operator with its body. We call this process &quot;operator inlining&quot;.
This cannot be done for recursive operators, for two reasons:</p>
<ol>
<li>
<p>A recursive operator may be non-terminating (although a non-terminating
operator is useless in TLA+);</p>
</li>
<li>
<p>A terminating call to an operator may take an unpredicted number of iterations.</p>
</li>
</ol>
<p>However, in practice, when one fixes specification parameters (that is,
<code>CONSTANTS</code>), it is usually easy to find a bound on the number of operator
iterations. For instance, consider the following specification:</p>
<pre><code class="language-tla">--------- MODULE Rec6 -----------------
EXTENDS Integers

N == 5

VARIABLES
    \* @type: Set(Int);
    set,
    \* @type: Int;
    count

RECURSIVE Sum(_)

Sum(S) ==
  IF S = {}
  THEN 0
  ELSE LET x == CHOOSE y \in S: TRUE IN
    x + Sum(S \ {x})

UNROLL_DEFAULT_Sum == 0
UNROLL_TIMES_Sum == N

Init ==
  /\ set = {}
  /\ count = 0

Next ==
  \E x \in (1..N) \ set:
    /\ count' = count + x
    /\ set' = set \union {x}

Inv == count = Sum(set)
=======================================    

</code></pre>
<p>It is clear that the expression <code>Sum(S)</code> requires the number of iterations that
is equal to <code>Cardinality(S) + 1</code>. Moreover, the expression <code>set \subseteq 1..N</code> is an invariant, and thus every call <code>Sum(set)</code> requires up to <code>N+1</code>
iterations.</p>
<p>When we can find an upper bound on the number of iterations, Apalache can
unroll the recursive operator up to this bound. To this end, we define two
additional operators. For instance:</p>
<pre><code class="language-tla">--------- MODULE Rec6 -----------------
EXTENDS Integers

N == 5

VARIABLES
    \* @type: Set(Int);
    set,
    \* @type: Int;
    count

RECURSIVE Sum(_)

Sum(S) ==
  IF S = {}
  THEN 0
  ELSE LET x == CHOOSE y \in S: TRUE IN
    x + Sum(S \ {x})

UNROLL_DEFAULT_Sum == 0
UNROLL_TIMES_Sum == N

Init ==
  /\ set = {}
  /\ count = 0

Next ==
  \E x \in (1..N) \ set:
    /\ count' = count + x
    /\ set' = set \union {x}

Inv == count = Sum(set)
=======================================    

</code></pre>
<p>In this case, Apalache unrolls every call to <code>Sum</code> exactly <code>UNROLL_TIMES_Sum</code>
times, that is, four times. On the default branch, Apalache places
<code>UNROLL_DEFAULT_Sum</code>, that is, 0.</p>
<p>All recursively defined operators should follow this convention where, for every such operator <code>Oper</code>, the user defines both <code>UNROLL_TIMES_Oper</code>, which expands to a positive integer value, and <code>UNROLL_DEFAULT_Oper</code>, which expands to some default value <code>Oper(args*)</code> should take, if the computation would require more than <code>UNROLL_TIMES_Oper</code> recursive calls.
At present, we only support literals (e.g. <code>4</code>) or primitive arithmetic expressions (e.g. <code>2 + 2</code>) in the body of <code>UNROLL_TIMES_Oper</code>.</p>
<p><a name="rec-fun"></a></p>
<h4><a class="header" href="#recursive-functions" id="recursive-functions">Recursive functions</a></h4>
<p>Apalache offers limited support for recursive functions. However, read the
warning below on why you should not use recursive functions. The restrictions
are as follows:</p>
<ol>
<li>
<p>Apalache supports recursive functions that return an integer or a Boolean.</p>
</li>
<li>
<p>As Apalache's simple type checker is not able to find the type of a
recursive function, all uses of a recursive function should come with a type
annotation.</p>
</li>
<li>
<p>As in TLC, the function domain must be a finite set.</p>
</li>
</ol>
<p>The example below shows a recursive function that computes the factorial of <code>n</code>.</p>
<pre><code class="language-tla">------------------------------ MODULE Rec8 ------------------------------------
EXTENDS Integers

VARIABLES
    \* @type: Int;
    n,
    \* @type: Int;
    factSpec,
    \* @type: Int;
    factComp

(*
 Defining a recursive function on a finite domain. Although it is rather
 unnatural to define factorial on a finite set, both Apalache and TLC
 require finite domains. As is usual for function application, the result
 of the application is not defined on the elements outside of the function
 domain.
 *)
Fact[k \in 1..20] ==
    IF k &lt;= 1
    THEN 1
    ELSE k * Fact[k - 1]

Init ==
    /\ n = 1
    /\ factSpec = Fact[n]
    /\ factComp = 1

Next ==     
    /\ n' = n + 1
    /\ factSpec' = Fact[n']
    /\ factComp' = n' * factComp

Inv ==
    factComp = factSpec

===============================================================================
</code></pre>
<p>Check other examples in
<a href="https://github.com/informalsystems/apalache/tree/unstable/test/tla"><code>test/tla</code></a> that
start with the prefix <code>Rec</code>.</p>
<p><strong>Why you should avoid recursive functions.</strong> Sometimes, recursive functions
concisely describe the function that you need. The nice examples are the
factorial function (see above) and Fibonacci numbers (see
<a href="https://github.com/informalsystems/apalache/blob/unstable/test/tla/Rec3.tla">Rec3</a>).
However, when you define a recursive function over sets, the complexity gets
ugly really fast.</p>
<p>Consider the example
<a href="https://github.com/informalsystems/apalache/blob/unstable/test/tla/Rec9.tla">Rec9</a>,
which computes set cardinality. Here is a fragment of the spec:</p>
<pre><code class="language-tla"> The set cardinality function. It needs an upper bound on the set size.
 Although this function looks nice, be warned that this definition requires us
 to construct the powerset SUBSET NUMS and then write down the constraints
 for the function Card. This encoding is (at least) double-exponential.
 *)
Card[S \in SUBSET NUMS] ==
    IF S = {}
    THEN 0
    ELSE LET i == CHOOSE j \in S: TRUE IN
        1 + Card[S \ {i}]

Init ==
    /\ set = {}
    /\ size = 0
</code></pre>
<p>Since we cannot fix the order, in which the set elements are evaluated, we
define function <code>Card</code> over <code>SUBSET NUMS</code>, that is, all possible subsets of
<code>NUMS</code>. Apalache translates the function in a quantifier-free theory of SMT.
Hence, in this case, Apalache expands <code>SUBSET NUMS</code>, so it introduces
<code>2^|NUMS|</code> sets! Further, Apalache writes down the SMT constraints for the
domain of <code>Card</code>. As a result, it produces <code>NUMS * 2^|NUMS|</code> constraints.
As you can see, recursive functions over sets explode quite fast.</p>
<p>It is usually a good idea to use recursive operators over sets rather than
recursive functions. The downside is that you have to provide an upper bound on
the number of the operator iterations. The upside is that recursive operators
are usually unrolled more efficiently. (If they contain only constant
expressions, they are even computed by the translator!) For instance, set
cardinality does not require <code>2^|NUMS|</code> constraints, when using a recursive
operator.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../apalache/principles/apalache-mod.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../apalache/principles/naturals.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../apalache/principles/apalache-mod.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../apalache/principles/naturals.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
